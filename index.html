<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî CareerDay</title>

<!-- Telegram Web App SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- VK Bridge SDK -->
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Golos+Text:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg: #F4F4F4;
    --orange: #F46D00;
    --orange-dark: #d45e00;
    --orange-light: rgba(244, 109, 0, 0.10);
    --white: #FFFFFF;
    --text: #333333;
    --muted: #888888;
    --border: #E8E8E8;
    --radius: 14px;
    --shadow: 0 2px 12px rgba(0,0,0,0.07);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Golos Text', sans-serif;
    min-height: 100vh;
    padding-bottom: 40px;
  }

  .header {
    background: var(--white);
    box-shadow: var(--shadow);
    padding: 16px 20px;
    display: flex; align-items: center; gap: 12px;
    position: sticky; top: 0; z-index: 10;
  }
  .header-icon {
    width: 40px; height: 40px;
    background: var(--orange); border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .header-title { font-size: 17px; font-weight: 700; line-height: 1.2; }
  .header-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

  .content {
    padding: 20px 16px 0;
    max-width: 520px; margin: 0 auto;
  }

  .state { display: none; }
  .state.active { display: block; animation: fadeUp 0.3s ease both; }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .card {
    background: var(--white); border-radius: var(--radius);
    box-shadow: var(--shadow); padding: 24px 20px;
  }
  .card h2 { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .card p { font-size: 14px; color: var(--muted); margin-bottom: 20px; line-height: 1.55; }

  .input-group { margin-bottom: 4px; }
  .input-group input {
    width: 100%;
    border: 2px solid var(--border); border-radius: 10px;
    padding: 13px 16px;
    font-family: 'Golos Text', sans-serif; font-size: 15px; color: var(--text);
    background: var(--bg); outline: none;
    transition: border-color 0.2s, background 0.2s;
  }
  .input-group input:focus { border-color: var(--orange); background: var(--white); }
  .input-group input::placeholder { color: #bbb; }
  .input-group input.invalid { border-color: #e03e3e; }
  .input-hint { font-size: 12px; color: #e03e3e; margin: 5px 0 14px 4px; min-height: 16px; }

  .btn {
    border: none; border-radius: 10px; padding: 14px;
    font-family: 'Golos Text', sans-serif; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: background 0.15s, transform 0.1s;
    display: inline-flex; align-items: center; justify-content: center; gap: 7px;
  }
  .btn:active { transform: scale(0.98); }
  .btn-primary { background: var(--orange); color: #fff; width: 100%; }
  .btn-primary:hover { background: var(--orange-dark); }
  .btn-ghost {
    background: var(--orange-light); color: var(--orange);
    padding: 10px 18px; margin-top: 14px; font-size: 14px;
  }
  .btn-ghost:hover { background: rgba(244,109,0,0.18); }

  .loader-wrap {
    display: flex; flex-direction: column;
    align-items: center; padding: 60px 0; gap: 14px;
  }
  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border); border-top-color: var(--orange);
    border-radius: 50%; animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loader-text { font-size: 14px; color: var(--muted); }

  .not-found { text-align: center; padding: 6px 0 2px; }
  .not-found .nf-icon { font-size: 46px; margin-bottom: 14px; }
  .not-found h2 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .not-found p { font-size: 14px; color: var(--muted); line-height: 1.6; }

  .events-meta { margin-bottom: 16px; }
  .events-meta h2 { font-size: 20px; font-weight: 700; }
  .events-meta p { font-size: 13px; color: var(--muted); margin-top: 3px; }

  /* Event card */
  .event-card {
    background: var(--white); border-radius: var(--radius);
    box-shadow: var(--shadow); margin-bottom: 16px; overflow: hidden;
  }
  .event-head {
    background: var(--orange); padding: 14px 18px;
    display: flex; align-items: center; gap: 10px;
  }
  .event-head-icon { font-size: 22px; }
  .event-head-info { flex: 1; min-width: 0; }
  .event-head-label {
    font-size: 10px; font-weight: 600; letter-spacing: 0.1em;
    text-transform: uppercase; color: rgba(255,255,255,0.7); margin-bottom: 2px;
  }
  .event-head-name {
    font-size: 16px; font-weight: 700; color: #fff;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .event-id-chip {
    background: rgba(255,255,255,0.2); color: #fff;
    font-size: 11px; font-weight: 600; padding: 4px 9px; border-radius: 6px; flex-shrink: 0;
  }

  .section { padding: 16px 18px; border-bottom: 1px solid var(--border); }
  .section:last-child { border-bottom: none; }
  .section-label {
    font-size: 11px; font-weight: 600; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--muted); margin-bottom: 10px;
  }

  .ref-box {
    background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
    padding: 11px 14px; display: flex; align-items: center; gap: 10px;
  }
  .ref-link-text {
    flex: 1; font-size: 12px; color: var(--orange);
    word-break: break-all; line-height: 1.5; font-family: monospace;
  }
  .copy-btn {
    flex-shrink: 0; background: var(--orange); color: #fff;
    border: none; border-radius: 8px; padding: 7px 12px;
    font-family: 'Golos Text', sans-serif; font-size: 12px; font-weight: 700;
    cursor: pointer; transition: background 0.15s, transform 0.1s; white-space: nowrap;
  }
  .copy-btn:active { transform: scale(0.95); }
  .copy-btn.copied { background: #4ade80; }

  .share-btn {
    display: flex; align-items: center; justify-content: center; gap: 7px;
    width: 100%; margin-top: 10px;
    background: var(--orange-light); border: 1px solid rgba(244,109,0,0.25);
    border-radius: 10px; padding: 10px;
    color: var(--orange); font-family: 'Golos Text', sans-serif;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.15s;
  }
  .share-btn:active { background: rgba(244,109,0,0.2); }

  .invited-row { display: flex; align-items: baseline; gap: 6px; margin-bottom: 14px; }
  .invited-num { font-size: 36px; font-weight: 700; color: var(--orange); line-height: 1; }
  .invited-label { font-size: 14px; color: var(--muted); }

  .progress-track {
    background: var(--bg); border-radius: 99px; height: 8px; overflow: hidden; margin-bottom: 8px;
  }
  .progress-fill {
    height: 100%; background: linear-gradient(90deg, var(--orange), #ff9a3c);
    border-radius: 99px; width: 0%; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .progress-milestones { display: flex; justify-content: space-between; margin-bottom: 16px; }
  .milestone {
    font-size: 11px; color: var(--muted);
    display: flex; flex-direction: column; align-items: center; gap: 3px;
  }
  .milestone.reached { color: var(--orange); font-weight: 600; }
  .milestone-dot { width: 6px; height: 6px; background: var(--border); border-radius: 50%; }
  .milestone.reached .milestone-dot { background: var(--orange); }

  .bonus-text { font-size: 13px; line-height: 1.75; color: var(--text); }

  .perforation {
    position: relative; border-top: 2px dashed var(--border); margin: 0 18px;
  }
  .perforation::before, .perforation::after {
    content: ''; position: absolute; width: 20px; height: 20px;
    background: var(--bg); border-radius: 50%; top: 50%; transform: translateY(-50%);
  }
  .perforation::before { left: -28px; }
  .perforation::after  { right: -28px; }

  .error-card {
    background: #fff5f5; border: 1px solid #ffd6d6;
    border-radius: var(--radius); padding: 20px;
    color: #c0392b; font-size: 14px; text-align: center;
  }

  /* VK snackbar */
  .snackbar {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: #333; color: #fff; padding: 10px 20px; border-radius: 10px;
    font-size: 14px; font-weight: 600; opacity: 0;
    transition: opacity 0.25s, transform 0.25s;
    pointer-events: none; z-index: 9999; white-space: nowrap;
  }
  .snackbar.show {
    opacity: 1; transform: translateX(-50%) translateY(0);
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-icon">üéÅ</div>
  <div>
    <div class="header-title">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</div>
    <div class="header-sub">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π ‚Äî –ø–æ–ª—É—á–∞–π –ø—Ä–∏–∑—ã</div>
  </div>
</div>

<div class="content">

  <!-- Search -->
  <div class="state active" id="state-search">
    <div class="card">
      <h2>–ù–∞–π—Ç–∏ –º–æ—é –ø—Ä–æ–≥—Ä–∞–º–º—É</h2>
      <p>–í–≤–µ–¥–∏ email, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ CareerDay.</p>
      <div class="input-group">
        <input type="email" id="email-input" placeholder="example@mail.ru"
               autocomplete="email" inputmode="email"
               onkeydown="if(event.key==='Enter') doSearch()" />
      </div>
      <div class="input-hint" id="email-hint"></div>
      <button class="btn btn-primary" onclick="doSearch()">üîç –ù–∞–π—Ç–∏</button>
    </div>
  </div>

  <!-- Loading -->
  <div class="state" id="state-loading">
    <div class="loader-wrap">
      <div class="spinner"></div>
      <div class="loader-text">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
    </div>
  </div>

  <!-- Not found -->
  <div class="state" id="state-notfound">
    <div class="card">
      <div class="not-found">
        <div class="nf-icon">üîç</div>
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h2>
        <p>–ü–æ —ç—Ç–æ–º—É email –º—ã –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏.<br/>–ü—Ä–æ–≤–µ—Ä—å –∞–¥—Ä–µ—Å –∏–ª–∏ –æ–±–Ω–æ–≤–∏ –±–æ—Ç –∫–æ–º–∞–Ω–¥–æ–π <b>/start</b>.</p>
      </div>
      <button class="btn btn-ghost" onclick="goBack()">‚Üê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>
  </div>

  <!-- Error -->
  <div class="state" id="state-error">
    <div class="error-card" id="error-msg">–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.</div>
    <button class="btn btn-ghost" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
  </div>

  <!-- Events -->
  <div class="state" id="state-events">
    <div class="events-meta">
      <h2>–¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h2>
      <p id="events-sub"></p>
    </div>
    <div id="events-container"></div>
    <button class="btn btn-ghost" onclick="goBack()">‚Üê –ò—Å–∫–∞—Ç—å –ø–æ –¥—Ä—É–≥–æ–º—É email</button>
  </div>

</div>

<!-- Fallback snackbar for non-VK environments -->
<div class="snackbar" id="snackbar">‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>

<script>
// =====================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ‚Äî –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π URL Gateway
// =====================================================
const FUNCTION_URL = "https://d5dk04fviigibe7grbeh.ql6wied2.apigw.yandexcloud.net/referral";
// =====================================================

// ‚îÄ‚îÄ‚îÄ Platform detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const platform = (() => {
  // VK Bridge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –≤–Ω—É—Ç—Ä–∏ VK Mini App.
  // vkBridge.isWebView() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true –∫–æ–≥–¥–∞ –µ—Å—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–π bridge.
  let _isVK = false;
  let _isTG = false;

  try {
    if (typeof vkBridge !== 'undefined') {
      vkBridge.send('VKWebAppInit').catch(() => {});
      // –°—á–∏—Ç–∞–µ–º VK, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∏–∑ VK (–µ—Å—Ç—å vk_* params –∏–ª–∏ bridge –æ—Ç–≤–µ—á–∞–µ—Ç)
      const params = new URLSearchParams(window.location.search);
      _isVK = params.has('vk_app_id') || params.has('vk_user_id') || vkBridge.isWebView();
    }
  } catch (e) {}

  if (!_isVK && typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.initData) {
    _isTG = true;
  }

  return { isVK: _isVK, isTG: _isTG };
})();

const tg = (platform.isTG && window.Telegram?.WebApp) ? window.Telegram.WebApp : null;
if (tg) { tg.ready(); tg.expand(); }

// ‚îÄ‚îÄ‚îÄ Snackbar (fallback for browser / TG) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let snackbarTimer = null;
function showSnackbar(text = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ') {
  const el = document.getElementById('snackbar');
  el.textContent = text;
  el.classList.add('show');
  if (snackbarTimer) clearTimeout(snackbarTimer);
  snackbarTimer = setTimeout(() => el.classList.remove('show'), 2200);
}

// ‚îÄ‚îÄ‚îÄ Copy to clipboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyToClipboard(text, btn) {
  const doAfterCopy = () => {
    if (platform.isVK) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º VKWebAppShowSnackbar –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
      vkBridge.send('VKWebAppShowSnackbar', { text: '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ ‚úì' })
        .catch(() => showSnackbar('‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')); // fallback –µ—Å–ª–∏ –º–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω
    } else {
      // –î–ª—è TG –∏ –±—Ä–∞—É–∑–µ—Ä–∞ ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π snackbar + –∞–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
      const orig = btn.textContent;
      btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = orig; btn.classList.remove('copied'); }, 2000);
      showSnackbar('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
    }
  };

  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(doAfterCopy).catch(() => {
      legacyCopy(text);
      doAfterCopy();
    });
  } else {
    legacyCopy(text);
    doAfterCopy();
  }
}

function legacyCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.cssText = 'position:fixed;opacity:0;top:0;left:0';
  document.body.appendChild(ta);
  ta.focus(); ta.select();
  try { document.execCommand('copy'); } catch (e) {}
  document.body.removeChild(ta);
}

// ‚îÄ‚îÄ‚îÄ Share ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shareLink(link, cdName) {
  const text = `–ò–¥—É –Ω–∞ CareerDay ${cdName} –æ—Ç FutureToday! –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –ø–æ –º–æ–µ–π —Å—Å—ã–ª–∫–µ üöÄ`;

  if (platform.isVK) {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π —à–∞—Ä–∏–Ω–≥ VK
    vkBridge.send('VKWebAppShare', { link })
      .catch(() => {
        // Fallback: –æ—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª —á–µ—Ä–µ–∑ URL
        const vkShareUrl =
          `https://vk.com/share.php?url=${encodeURIComponent(link)}&title=${encodeURIComponent(text)}&noparse=true`;
        vkBridge.send('VKWebAppOpenExternalLink', { url: vkShareUrl })
          .catch(() => window.open(vkShareUrl, '_blank'));
      });
    return;
  }

  if (platform.isTG && tg) {
    tg.openTelegramLink(
      `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`
    );
    return;
  }

  // Plain browser fallback
  if (navigator.share) {
    navigator.share({ title: `CareerDay ${cdName}`, text, url: link }).catch(() => {});
  } else {
    window.open(
      `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`,
      '_blank'
    );
  }
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CD_NAMES = {
  "–ü–§–ú":  "ProFinance –ú–æ—Å–∫–≤–∞",
  "–ù–ò–¢–ú": "–ù–∞–π–¥–∏ IT –ú–æ—Å–∫–≤–∞",
  "–¢–°–ú":  "TechnoCareer",
  "–ü–§–°":  "ProFinance –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
  "–ù–ò–¢–°": "–ù–∞–π–¥–∏ IT –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
  "–ù–ò–¢–ù": "–ù–∞–π–¥–∏ IT –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫",
  "–î–û–í":  "–î–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π",
  "–ö–ó–ö–§": "FutureToday Career Forum",
};
const CD_ICONS = {
  "–ü–§–ú": "üíº", "–ù–ò–¢–ú": "üíª", "–¢–°–ú": "üöÄ",
  "–ü–§–°": "üíº", "–ù–ò–¢–°": "üíª", "–ù–ò–¢–ù": "üíª",
  "–î–û–í": "üè¢", "–ö–ó–ö–§": "üåü",
};

const shareLabel = platform.isVK
  ? 'üîµ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –í–ö–æ–Ω—Ç–∞–∫—Ç–µ'
  : '‚úàÔ∏è –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Telegram';

function pluralInvited(n) {
  if (n === 1) return '–¥—Ä—É–≥ –ø—Ä–∏–≥–ª–∞—à—ë–Ω';
  if (n >= 2 && n <= 4) return '–¥—Ä—É–≥–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ';
  return '–¥—Ä—É–∑–µ–π –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ';
}

// ‚îÄ‚îÄ‚îÄ State machine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setState(id) {
  document.querySelectorAll('.state').forEach(el => el.classList.remove('active'));
  document.getElementById('state-' + id).classList.add('active');
}

function goBack() {
  document.getElementById('email-input').value = '';
  document.getElementById('email-hint').textContent = '';
  document.getElementById('email-input').classList.remove('invalid');
  setState('search');
}

function isValidEmail(e) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(e.trim());
}

// ‚îÄ‚îÄ‚îÄ Render event card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEvent(ev) {
  const { careerday, row_id, ref_link, invited_count, referral_text } = ev;
  const name = CD_NAMES[careerday] || careerday;
  const icon = CD_ICONS[careerday] || 'üé´';
  const pct = Math.min(Math.round((invited_count / 5) * 100), 100);
  const m3 = invited_count >= 3;
  const m5 = invited_count >= 5;
  const fillId = `fill-${row_id}`;

  // Safely escape for inline onclick attributes
  const safeName = name.replace(/'/g, "\\'");
  const safeLink = ref_link ? ref_link.replace(/'/g, "\\'") : '';

  const card = document.createElement('div');
  card.className = 'event-card';
  card.innerHTML = `
    <div class="event-head">
      <span class="event-head-icon">${icon}</span>
      <div class="event-head-info">
        <div class="event-head-label">CareerDay</div>
        <div class="event-head-name">${name}</div>
      </div>
      <div class="event-id-chip">#${row_id}</div>
    </div>

    ${ref_link ? `
    <div class="section">
      <div class="section-label">–¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
      <div class="ref-box">
        <span class="ref-link-text">${ref_link}</span>
        <button class="copy-btn" onclick="copyToClipboard('${safeLink}', this)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <button class="share-btn" onclick="shareLink('${safeLink}', '${safeName}')">
        ${shareLabel}
      </button>
    </div>
    ` : ''}

    <div class="perforation"></div>

    <div class="section">
      <div class="section-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div class="invited-row">
        <span class="invited-num">${invited_count}</span>
        <span class="invited-label">${pluralInvited(invited_count)}</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="${fillId}"></div>
      </div>
      <div class="progress-milestones">
        <div class="milestone ${m3 ? 'reached' : ''}">
          <div class="milestone-dot"></div>
          <span>3 üçï</span>
        </div>
        <div class="milestone ${m5 ? 'reached' : ''}">
          <div class="milestone-dot"></div>
          <span>5 üíµ</span>
        </div>
        <div class="milestone">
          <div class="milestone-dot"></div>
          <span>üèÜ</span>
        </div>
      </div>
      <div class="bonus-text">${referral_text.replace(/\n/g, '<br/>')}</div>
    </div>
  `;

  return { card, fillId, pct };
}

// ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doSearch() {
  const input = document.getElementById('email-input');
  const hint = document.getElementById('email-hint');
  const email = input.value.trim();

  if (!email) {
    hint.textContent = '–í–≤–µ–¥–∏ email';
    input.classList.add('invalid');
    input.focus();
    return;
  }
  if (!isValidEmail(email)) {
    hint.textContent = '–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email';
    input.classList.add('invalid');
    input.focus();
    return;
  }
  hint.textContent = '';
  input.classList.remove('invalid');

  setState('loading');

  try {
    const resp = await fetch(`${FUNCTION_URL}?email=${encodeURIComponent(email)}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();

    if (!data.found) {
      setState('notfound');
      return;
    }

    const container = document.getElementById('events-container');
    container.innerHTML = '';
    const fills = [];

    data.events.forEach(ev => {
      const { card, fillId, pct } = renderEvent(ev);
      container.appendChild(card);
      fills.push({ fillId, pct });
    });

    const n = data.events.length;
    document.getElementById('events-sub').textContent =
      n === 1 ? '–ù–∞–π–¥–µ–Ω–æ 1 –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ' : `–ù–∞–π–¥–µ–Ω–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: ${n}`;

    setState('events');

    requestAnimationFrame(() => {
      setTimeout(() => {
        fills.forEach(({ fillId, pct }) => {
          const el = document.getElementById(fillId);
          if (el) el.style.width = pct + '%';
        });
      }, 200);
    });

  } catch (e) {
    document.getElementById('error-msg').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message;
    setState('error');
  }
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  setTimeout(() => document.getElementById('email-input').focus(), 200);
});
</script>
</body>
</html>
